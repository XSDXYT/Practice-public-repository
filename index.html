<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GW2 Fractal CM 异变查看器（离线/在线，含中文）</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background: #0b0d10; color: #e8eef6; }
    header { padding: 14px 14px 10px; background: #11151b; position: sticky; top: 0; z-index: 9; border-bottom: 1px solid #1f2a36; }
    h1 { font-size: 16px; margin: 0 0 8px; font-weight: 700; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .grid2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
    .card { background: #0f141b; border: 1px solid #1f2a36; border-radius: 14px; padding: 12px; }
    label { font-size: 12px; opacity: 0.9; display: block; margin-bottom: 6px; }
    input[type="date"], input[type="file"], input[type="text"], select {
      width: 100%; box-sizing: border-box;
      background: #0b0f14; color: #e8eef6;
      border: 1px solid #273447; border-radius: 10px;
      padding: 10px 10px; font-size: 14px;
    }
    button {
      border: 1px solid #2b3b52; background: #121a24; color: #e8eef6;
      padding: 10px 10px; border-radius: 12px; font-size: 14px; font-weight: 600;
    }
    button:active { transform: scale(0.99); }
    .muted { opacity: 0.75; font-size: 12px; line-height: 1.35; }
    .warn { color: #ffd18a; }
    .ok { color: #9ef0b1; }
    .err { color: #ff9aa2; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip { font-size: 12px; border: 1px solid #2a3a51; padding: 6px 10px; border-radius: 999px; background:#0b1016; }
    .result { padding: 12px 14px 24px; }
    .titleLine { display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .titleLine h2 { margin: 0; font-size: 14px; }
    .titleLine .small { font-size: 12px; opacity: 0.8; }
    ol { margin: 10px 0 0 18px; padding: 0; }
    li { margin: 6px 0; }
    .hr { height: 1px; background: #1f2a36; margin: 10px 0; }
    .footer { padding: 14px; opacity: 0.75; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<header>
  <h1>GW2 Fractal CM 异变查看器（离线/在线，含中文）</h1>
  <div class="row">
    <div class="card">
      <div class="grid2">
        <div>
          <label>导入 instabilities.json（必需）</label>
          <input id="fileInst" type="file" accept=".json,application/json" />
        </div>
        <div>
          <label>导入 fractals.json（可选：显示碎层名字更友好）</label>
          <input id="fileFract" type="file" accept=".json,application/json" />
        </div>
        <div>
          <label>导入 zh_dict.json（可选：显示中文名）</label>
          <input id="fileZh" type="file" accept=".json,application/json" />
          <div class="muted" style="margin-top:8px;">
            在线模式会尝试自动读取同目录的 <span class="mono">./zh_dict.json</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>要查询的日期</label>
          <input id="datePick" type="date" />
          <div class="chips">
            <button id="btnToday" type="button">今天</button>
            <button id="btnTomorrow" type="button">明天</button>
          </div>
        </div>
        <div>
          <label>循环起始日（Anchor）</label>
          <input id="anchorPick" type="date" />
          <div class="muted warn" style="margin-top:8px;">
            说明：你的 JSON 里只有 366 天的表，所以需要一个“起始日”来对齐。<br/>
            默认用 <span class="mono">2023-12-31</span>。如果你发现结果和游戏不一致，把这里改到正确的起始日即可。
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="muted" id="status">状态：<span class="err">未加载数据</span></div>
        <div class="muted" id="calcInfo"></div>
      </div>
    </div>
  </div>
</header>

<div class="result">
  <div class="card" id="outputCard">
    <div class="muted">加载 JSON 后会在这里显示 6 个 CM（95~100）的异变。</div>
  </div>
</div>

<div class="footer">
  小贴士：
  1) 离线：把 HTML 和 json 放在同目录，本地浏览器直接打开即可。
  2) 在线（GitHub Pages）：同目录放置 instabilities.json / fractals.json / zh_dict.json 会自动加载并显示中文。
</div>

<script>
  // -------------------------
  // Helpers
  // -------------------------
  const $ = (id) => document.getElementById(id);

  function parseJsonFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("读取失败"));
      reader.onload = () => {
        try { resolve(JSON.parse(reader.result)); }
        catch (e) { reject(new Error("JSON 解析失败：" + e.message)); }
      };
      reader.readAsText(file, "utf-8");
    });
  }

  function fmtDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }


  // 获取北京时间的日期/时间部件（不依赖用户电脑时区）
  function getBeijingParts(now = new Date()) {
    const fmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Shanghai",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
    const parts = {};
    for (const p of fmt.formatToParts(now)) {
      if (p.type !== "literal") parts[p.type] = p.value;
    }
    return {
      year: Number(parts.year),
      month: Number(parts.month),
      day: Number(parts.day),
      hour: Number(parts.hour),
      minute: Number(parts.minute),
      second: Number(parts.second),
    };
  }

  // 国服重置：北京时间 08:00。把“游戏日期”定义为：北京时间 < 08:00 时算前一天。
  function getGw2CnGameDateStr(now = new Date()) {
    const p = getBeijingParts(now);
    // 用 UTC Date 承载“北京时间”的年月日时分秒，方便做日期加减
    const d = new Date(Date.UTC(p.year, p.month - 1, p.day, p.hour, p.minute, p.second));
    if (p.hour < 8) d.setUTCDate(d.getUTCDate() - 1);
    // 输出 YYYY-MM-DD（使用 UTC 取值，避免本地时区影响）
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth() + 1).padStart(2, "0");
    const day = String(d.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  // 计算距离下一个北京时间 08:00 还有多久（毫秒）
  function msUntilNextCnReset(now = new Date()) {
    const p = getBeijingParts(now);
    const todayResetUtc = Date.UTC(p.year, p.month - 1, p.day, 8, 0, 0);
    const nowUtc = Date.UTC(p.year, p.month - 1, p.day, p.hour, p.minute, p.second);
    let next = todayResetUtc;
    if (nowUtc >= todayResetUtc) {
      const tmp = new Date(todayResetUtc);
      tmp.setUTCDate(tmp.getUTCDate() + 1);
      next = tmp.getTime();
    }
    return Math.max(0, next - nowUtc);
  }

  function toLocalDateFromInput(value) {
    // value: "YYYY-MM-DD"
    const [y,m,d] = value.split("-").map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  }

  function dayDiff(a, b) {
    // a,b are Date at midnight local
    const ms = 24*60*60*1000;
    return Math.round((a.getTime() - b.getTime()) / ms);
  }


  // 基于 YYYY-MM-DD 做日期加减
  function addDaysToDateStr(dateStr, deltaDays) {
    const d = toLocalDateFromInput(dateStr);
    d.setDate(d.getDate() + deltaDays);
    return fmtDate(d);
  }

  function setDatePickValue(dateStr, { manual = true } = {}) {
    suppressDateChangeFlag = true;
    $("datePick").value = dateStr;
    suppressDateChangeFlag = false;
    if (manual) userManualDate = true;
    render();
    refreshQuickJumpOptions();
  }

  function setFollowCnResetToday() {
    userManualDate = false;
    lastAutoDateStr = getGw2CnGameDateStr(new Date());
    suppressDateChangeFlag = true;
    $("datePick").value = lastAutoDateStr;
    suppressDateChangeFlag = false;
    render();
    refreshQuickJumpOptions();
  }

  function refreshQuickJumpOptions() {
    const sel = $("quickJump");
    if (!sel) return;

    const gameToday = getGw2CnGameDateStr(new Date());
    const current = $("datePick").value || gameToday;

    const prev = sel.value;
    sel.innerHTML = "";

    const optFollow = document.createElement("option");
    optFollow.value = "__FOLLOW__";
    optFollow.textContent = "跟随国服 08:00 自动（推荐）";
    sel.appendChild(optFollow);

    for (let i = -14; i <= 14; i++) {
      const d = addDaysToDateStr(gameToday, i);
      const opt = document.createElement("option");
      opt.value = d;
      let tag = "";
      if (i === 0) tag = "（游戏今天）";
      else if (i === 1) tag = "（游戏明天）";
      else if (i === -1) tag = "（游戏昨天）";
      opt.textContent = `${d} ${tag}`.trim();
      sel.appendChild(opt);
    }

    if (!userManualDate) {
      sel.value = "__FOLLOW__";
    } else {
      sel.value = current;
      if (sel.value !== current) {
        const opt = document.createElement("option");
        opt.value = current;
        opt.textContent = `${current}（当前）`;
        sel.insertBefore(opt, sel.children[1]);
        sel.value = current;
      }
    }

    if (prev && Array.from(sel.options).some(o => o.value === prev)) {
      sel.value = prev;
    }
  }

  // -------------------------
  // App State
  // -------------------------
  let instData = null;     // from instabilities.json
  let fractData = null;    // from fractals.json (optional)
  let zhDict = null;       // from zh_dict.json (optional) => {fractals:{}, instabilities:{}}

  // Try to infer CM scale -> fractal type/name via fractals.json
  // Returns { slug, en } or null
  function getFractalInfoByScale(scale) {
    if (!fractData || !Array.isArray(fractData.scales)) return null;
    const item = fractData.scales.find(x => x.scale === scale);
    if (!item) return null;
    const slug = item.type;

    const details = fractData.fractal_details && fractData.fractal_details[slug];
    const en = (details && details.name && details.name.en) ? details.name.en : slug;
    return { slug, en };
  }

  function getZhFractalBySlug(slug) {
    if (!zhDict || !zhDict.fractals) return null;
    return zhDict.fractals[String(slug)] || null;
  }

  function getZhInstability(id) {
    if (!zhDict || !zhDict.instabilities) return null;
    return zhDict.instabilities[String(id)] || null;
  }

  function getInstabilityName(id) {
    if (!instData || !Array.isArray(instData.instability_details)) return `#${id}`;
    const row = instData.instability_details[id];
    if (!row || !row.name) return `#${id}`;
    // 文件里通常只有 de/en/es/fr，这里默认用英文
    return row.name.en || `#${id}`;
  }

  function render() {
    const out = $("outputCard");
    out.innerHTML = "";

    if (!instData || !instData.instabilities) {
      out.innerHTML = `<div class="muted">请先导入 <span class="mono">instabilities.json</span>。</div>`;
      return;
    }

    const dateStr = $("datePick").value;
    const anchorStr = $("anchorPick").value;

    if (!dateStr || !anchorStr) {
      out.innerHTML = `<div class="muted">请选择日期与 Anchor。</div>`;
      return;
    }

    const date = toLocalDateFromInput(dateStr);
    const anchor = toLocalDateFromInput(anchorStr);

    // JSON 每个 scale 都是 366 天
    const ROT = 366;
    const delta = dayDiff(date, anchor);
    const idx = ((delta % ROT) + ROT) % ROT;

    $("calcInfo").textContent = `计算：(${dateStr} - ${anchorStr}) = ${delta} 天 → idx=${idx}（mod ${ROT}）`;

    // CM scales：95~100（你这份 json 正好有 6 个，符合你说的“6个挑战模式”）
    const cmScales = [95, 96, 97, 98, 99, 100];

    const wrapper = document.createElement("div");
    wrapper.className = "row";

    cmScales.forEach(scale => {
      const byScale = instData.instabilities[String(scale)];
      const triple = byScale ? byScale[idx] : null;

      const fractInfo = getFractalInfoByScale(scale);
      const enName = fractInfo ? fractInfo.en : `Scale ${scale}`;
      const zhName = (fractInfo && fractInfo.slug) ? getZhFractalBySlug(fractInfo.slug) : null;
      const title = zhName ? `${enName}（${zhName}）` : `${enName}`;

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "titleLine";
      head.innerHTML = `<h2>${title}</h2><div class="small">CM Scale: ${scale}</div>`;
      card.appendChild(head);

      if (!triple || triple.length !== 3) {
        const msg = document.createElement("div");
        msg.className = "muted err";
        msg.style.marginTop = "8px";
        msg.textContent = "未找到该 Scale 的异变数据（检查 instabilities.json 是否完整）。";
        card.appendChild(msg);
      } else {
        const ol = document.createElement("ol");
        triple.forEach(id => {
          const li = document.createElement("li");
          const en = getInstabilityName(id);
          const zh = getZhInstability(id);
          li.textContent = zh ? `${en}（${zh}）  (id=${id})` : `${en}  (id=${id})`;
          ol.appendChild(li);
        });
        card.appendChild(ol);
      }

      wrapper.appendChild(card);
    });

    out.appendChild(wrapper);

    // status
    $("status").innerHTML = `状态：<span class="ok">已加载 instabilities.json</span>` + (fractData ? `，<span class="ok">已加载 fractals.json</span>` : `，<span class="warn">未加载 fractals.json（仅显示英文碎层名）</span>`) + (zhDict ? `，<span class="ok">已加载 zh_dict.json</span>` : `，<span class="warn">未加载 zh_dict.json（不显示中文）</span>`);
  }

  // -------------------------
  // Wire up UI
  // -------------------------
  (function init() {
    // default date = CN reset "game day"
    lastAutoDateStr = getGw2CnGameDateStr(new Date());
    const now = new Date();
    suppressDateChangeFlag = true;
    $("datePick").value = lastAutoDateStr;
    suppressDateChangeFlag = false;
// default anchor = 2023-12-31
    $("anchorPick").value = "2023-12-31";

    $("btnToday").addEventListener("click", () => {
      setFollowCnResetToday();
    });

    $("btnTomorrow").addEventListener("click", () => {
      // 以“游戏今天”为基准 +1 天
      const baseStr = getGw2CnGameDateStr(new Date());
      const base = toLocalDateFromInput(baseStr);
      base.setDate(base.getDate() + 1);
      suppressDateChangeFlag = true;
      $("datePick").value = fmtDate(base);
      suppressDateChangeFlag = false;
      userManualDate = true;
      render();
    });


    $("btnPrev").addEventListener("click", () => {
      const cur = $("datePick").value || getGw2CnGameDateStr(new Date());
      setDatePickValue(addDaysToDateStr(cur, -1), { manual: true });
    });

    $("btnNext").addEventListener("click", () => {
      const cur = $("datePick").value || getGw2CnGameDateStr(new Date());
      setDatePickValue(addDaysToDateStr(cur, +1), { manual: true });
    });

    $("btnPrev7").addEventListener("click", () => {
      const cur = $("datePick").value || getGw2CnGameDateStr(new Date());
      setDatePickValue(addDaysToDateStr(cur, -7), { manual: true });
    });

    $("btnNext7").addEventListener("click", () => {
      const cur = $("datePick").value || getGw2CnGameDateStr(new Date());
      setDatePickValue(addDaysToDateStr(cur, +7), { manual: true });
    });

    $("quickJump").addEventListener("change", (e) => {
      const v = e.target.value;
      if (v === "__FOLLOW__") {
        setFollowCnResetToday();
      } else {
        setDatePickValue(v, { manual: true });
      }
    });

    // 键盘快捷键：←/→ 前后一天；Shift+←/→ 前后 7 天
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey || e.metaKey || e.altKey) return;
      const key = e.key;
      if (key !== "ArrowLeft" && key !== "ArrowRight") return;

      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const isTyping = tag === "input" || tag === "textarea";
      if (isTyping && e.target.id !== "datePick") return;

      const delta = (key === "ArrowLeft" ? -1 : +1) * (e.shiftKey ? 7 : 1);
      const cur = $("datePick").value || getGw2CnGameDateStr(new Date());
      setDatePickValue(addDaysToDateStr(cur, delta), { manual: true });
      e.preventDefault();
    });

    refreshQuickJumpOptions();

    $("datePick").addEventListener("change", () => {
      if (!suppressDateChangeFlag) userManualDate = true;
      render();
      refreshQuickJumpOptions();
    });
    $("anchorPick").addEventListener("change", render);

    $("fileInst").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        instData = await parseJsonFile(file);
        render();
      } catch (err) {
        instData = null;
        $("status").innerHTML = `状态：<span class="err">${err.message}</span>`;
        render();
      }
    });

    $("fileFract").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { fractData = null; render(); return; }
      try {
        fractData = await parseJsonFile(file);
        render();
      } catch (err) {
        fractData = null;
        $("status").innerHTML = `状态：<span class="warn">fractals.json 加载失败（不影响使用）：${err.message}</span>`;
        render();
      }
    });

    $("fileZh").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { zhDict = null; render(); return; }
      try {
        zhDict = await parseJsonFile(file);
        render();
      } catch (err) {
        zhDict = null;
        $("status").innerHTML = `状态：<span class="warn">zh_dict.json 加载失败（不影响使用）：${err.message}</span>`;
        render();
      }
    });
    
    

    async function autoLoadJson() {
      // 多路径尝试：解决项目页 /repo/ 与用户页 / 的相对路径差异
      const origin = window.location.origin;
      const parts = window.location.pathname.split("/").filter(Boolean);
      const repoBase = parts.length ? `/${parts[0]}/` : "/"; // project pages: /repo/..., user pages: /
      const dirBase = new URL(".", window.location.href);    // 当前页面所在目录

      const candidates = (filename) => ([
        new URL(filename, dirBase).toString(),              // 当前目录
        new URL("./" + filename, dirBase).toString(),       // 当前目录（显式）
        origin + repoBase + filename,                       // 仓库根目录（project pages 兼容）
        origin + "/" + filename,                            // 站点根目录（user pages 兼容）
      ]);

      async function fetchJsonWithCandidates(filename) {
        const urls = candidates(filename);
        let lastErr = null;

        for (const url of urls) {
          try {
            const r = await fetch(url, { cache: "no-store" });
            if (!r.ok) {
              lastErr = new Error(`${filename} 读取失败：HTTP ${r.status}（${url}）`);
              continue;
            }
            const text = await r.text();
            try {
              const data = JSON.parse(text);
              return { ok: true, url, data };
            } catch (e) {
              lastErr = new Error(`${filename} JSON 解析失败：${e.message}（${url}）`);
              continue;
            }
          } catch (e) {
            lastErr = new Error(`${filename} 请求异常：${e.message}`);
          }
        }

        return { ok: false, urls, error: lastErr };
      }

      // instabilities.json（必需）
      const instRes = await fetchJsonWithCandidates("instabilities.json");
      if (!instRes.ok) {
        instData = null;
        $("status").innerHTML =
          `状态：<span class="err">未加载数据</span><br/>` +
          `<span class="warn">${instRes.error ? instRes.error.message : "未知错误"}</span><br/>` +
          `<span class="muted">尝试过的路径：</span><br/>` +
          instRes.urls.map(u => `<span class="mono">${u}</span>`).join("<br/>");
        render();
        return;
      }
      instData = instRes.data;

      // fractals.json（可选）
      const fractRes = await fetchJsonWithCandidates("fractals.json");
      if (fractRes.ok) fractData = fractRes.data;

      // zh_dict.json（可选）
      const zhRes = await fetchJsonWithCandidates("zh_dict.json");
      if (zhRes.ok) zhDict = zhRes.data;

      const partsStatus = [];
      partsStatus.push(`<span class="ok">已加载 instabilities.json</span>（<span class="mono">${instRes.url}</span>）`);
      partsStatus.push(fractRes.ok
        ? `<span class="ok">已加载 fractals.json</span>（<span class="mono">${fractRes.url}</span>）`
        : `<span class="warn">未加载 fractals.json（不影响查询）</span>`);
      partsStatus.push(zhRes.ok
        ? `<span class="ok">已加载 zh_dict.json</span>（<span class="mono">${zhRes.url}</span>）`
        : `<span class="warn">未加载 zh_dict.json（不显示中文）</span>`);

      $("status").innerHTML = "状态：" + partsStatus.join("，");
      render();
    }

    } 


    
    // 到北京时间 08:00 自动“刷新今天”（仅当你当前处于“跟随重置”的状态）
    function scheduleCnResetTick() {
      const delay = msUntilNextCnReset(new Date()) + 250; // 加一点缓冲
      setTimeout(() => {
        // 只有当用户没有手动挑日期时，才自动跳到新的一天
        if (!userManualDate) {
          lastAutoDateStr = getGw2CnGameDateStr(new Date());
          suppressDateChangeFlag = true;
          $("datePick").value = lastAutoDateStr;
          suppressDateChangeFlag = false;
          render();
          refreshQuickJumpOptions();
        }
        scheduleCnResetTick(); // 继续挂下一个 8 点
      }, delay);
    }
    scheduleCnResetTick();


    autoLoadJson();   // 自动加载（在线使用）
    render();         // 先渲染一个空壳界面

  })();
</script>
</body>
</html>
